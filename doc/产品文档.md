# DegenTempo MVP v2.0 - 产品需求与技术架构综合文档

这份文档整合了 DegenTempo MVP v2.0 的产品需求 (PRD) 与技术架构设计，旨在为开发团队提供从业务逻辑到技术实现的完整指南。

---

## 🟢 Part 1: 产品需求 (Product Requirements)

### 1. 项目愿景
**DegenTempo** 旨在为 Farcaster 社交生态提供最顺滑的变现路径。用户无需持有 Gas 费（ETH），即可一键将社交收益（**USDC**）或钱包资产转化为银行卡法币，通过 **Across 跨链桥**、**Tempo 链** 和 **Stripe** 实现价值闭环。

### 2. 核心业务逻辑 (The Core Loop)
1.  **身份层 (Auth):** 用户通过 Privy 登录 Farcaster，或连接 **MetaMask** 等外部钱包。
2.  **钱包层 (Wallet):** 系统为用户生成 **Base 链智能合约钱包 (ERC-4337)**，并自动关联 **Tempo 链** 收款地址。
3.  **资金归集 (Funding - The "Magic" Step):**
    *   **问题**: 用户资金在 Farcaster 钱包 (EOA) 或 MetaMask，通常需要 ETH 才能转账。
    *   **解法**: 利用 **USDC 的 EIP-2612 Permit / EIP-3009** 功能。
    *   **流程**: 用户链下签署 Permit 消息 -> Smart Account 在一笔交易中同时执行 `permit()` + `transferFrom()` 把资金拉取到 AA 钱包。全过程由 Paymaster 代付，用户 EOA 无需 ETH。
4.  **跨链层 (Bridging):** 集成 **Across Protocol** 跨链协议。
    *   直接路径：`Base (USDC) -> Across Bridge -> Tempo (USDC)`。
    *   **理由**: Across 在各大测试网为 USDC 建立了充足流动性，便于测试；且代码逻辑与跨 DEGEN 一致。
    *   **扩展性**: 后续支持其他代币只需替换代币地址。
5.  **免 Gas 层 (Gasless):**
    *   用户签署 **UserOperation**。
    *   **Alchemy/Biconomy Paymaster** 代付 Base 链 Gas 费。
    *   用户端体验为“零 ETH 消耗”。
6.  **结算层 (Settlement):**
    *   资产以 **USDC** 形式到达用户的 Tempo 钱包。
    *   用户在 Dashboard 点击 "Withdraw"，调用 **Stripe Crypto Payouts** 提现至银行卡。

### 2.1 资金流向 (Fund Flow)
为了确保透明度，以下是单笔交易中资金的流转路径：

*   **起点 (User Base Wallet):** 100% **USDC** (在用户 Privy EOA、MetaMask 或其他外部 EOA 中)。
    *   *Action:* 用户签署 `Permit` 消息，授权 AA 钱包拉取资金。
*   **归集 (AA Wallet):** Smart Account 通过 UserOp 执行 `transferFrom` 将资金拉入。
*   **跨链 (Across Bridge):** 资金进入 Across 协议合约。
    *   **费用**: 扣除 Across Relayer Fee 和 Bridge Fee。
    *   **转换**: 资产从 Base USDC 跨链为 **Tempo 链上的 USDC**。
*   **终点 (User Tempo Wallet):** 用户收到扣除手续费后的 **USDC**。
*   **法币出口 (Stripe Payout):**
    *   用户将 Tempo USDC 发送至 Stripe 指定充值地址。
    *   Stripe 结算等额法币至用户绑定的银行卡。
*   **Gas 成本:** 由平台在 Base 链通过 Paymaster 垫付，用户无需感知或持有 ETH。

### 3. 功能需求详细说明

#### 3.1 账户与安全 (Privy + AA)
*   **登录方式：** 
    *   **Farcaster 社交登录**：通过 Privy 授权。
    *   **钱包连接**：支持 **MetaMask**、Rainbow 等主流钱包连接。
*   **智能钱包 (Smart Account)：**
    *   集成 Privy 嵌入式钱包或外部连接的钱包 (MetaMask) 作为签名者 (Signer)。
    *   使用 Privy/Alchemy SDK 构建 AA 交易。
*   **免 Gas 机制：** 对接 **Alchemy Gas Manager**。
    *   平台预存 ETH 垫资。
    *   通过交易量带来的平台费覆盖 Gas 成本。

#### 3.2 资产管理与手续费 (Monetization)
*   **手续费模型：** Across Protocol 内置费用 (Relayer Fee + LP Fee)。
*   **前端展示：**
    *   **Quote 预览**：显示“原始金额”、“预估跨链费”、“预估到账 USDC”。
    *   **Gas 状态**：显示 "Sponsored by DegenTempo"。

#### 3.3 交易执行 (Bridge)
*   **跨链协议：** 使用 **Across Protocol SDK / Contracts**。
*   **关键技术：** 利用 **Permit** 实现 EOA -> AA 的无 Gas 资金转移。
*   **流程控制：**
    1.  **Get Quote**: 前端请求 Across 报价 (Suggested Fees)。
    2.  **Sign Permit**: 用户对 Permit 消息签名 (授权 AA 扣款)。
    3.  **Sign UserOp**: 用户对包含 `permit` + `transferFrom` + `deposit` (Across) 的 UserOp 签名。
    4.  **Execute**: Paymaster 提交上链。
    5.  **Track**: 前端轮询 Across API / Indexer 更新跨链进度。

#### 3.4 Stripe 合规出金 (Off-ramp)
*   **出金网关：** Stripe Crypto Payouts。
*   **流程：**
    *   用户选择 "Withdraw USDC from Tempo"。
    *   系统调用 Stripe API 获取充值地址。
    *   用户将 Tempo 链上的 USDC 转入该地址。
    *   Stripe 收到资金后通过 Webhook 通知后端。
    *   Stripe 自动结算法币到用户绑定的银行卡。

#### 3.5 异常与退款流程 (Refund & Fallback)
*   **跨链失败：** 若 Across 跨链超时或由于特殊原因失败（极少发生，Across 使用 Relayer 机制）。
    *   **处理：** 前端检测到状态异常，引导用户查看 Across Explorer。
*   **Stripe 充值未到账：**
    *   **处理：** 提供交易 Hash 给 Stripe 客服查询。系统保留所有链上 TxHash 以备核查。

---

## 🔵 Part 2: 技术架构 (Technical Architecture)

### 1. 核心架构理念 (Serverless + Direct Protocol)
DegenTempo v2.0 移除了传统的 Java 后端，全面拥抱 **Serverless** 架构。业务逻辑主要由前端 (Client) 直接与第三方协议交互，后端 (API Routes) 仅负责轻量级的数据持久化和敏感操作。

*   **前端驱动 (Client-Heavy):** 交易构建、签名、跨链路径寻找全部在客户端完成。
*   **后端辅助 (Serverless):** 仅用于记录流水、Stripe 签名和用户统计。
*   **协议直连 (Direct Protocol):** 直接集成 **Across Protocol** 和 Alchemy 基础设施。

### 2. 详细技术栈 (Tech Stack)
| 模块 | 选型 | 理由 |
| :--- | :--- | :--- |
| **Frontend** | **Next.js 14 (App Router)** | 现代 React 框架，SEO 友好，内置 API Routes。 |
| **Auth** | **Privy** | 专为 Farcaster 设计的登录与嵌入式钱包方案。 |
| **Database** | **PostgreSQL (via Prisma)** | 关系型数据存储，强类型 ORM，易于迁移。 |
| **Cross-Chain** | **Across Protocol** | 快速、低成本的意图导向跨链桥，USDC 流动性好。 |
| **Gasless** | **Alchemy Gas Manager** | 符合 ERC-4337 标准的 Paymaster 服务。 |
| **Smart Account** | **Light Account (Alchemy)** | 轻量级 AA 账户合约，Gas 消耗低。 |
| **Payments** | **Stripe Crypto Payouts** | 合规的法币出金渠道。 |

### 3. 数据流 (Data Flow)

#### 3.1 登录与账户初始化
1.  用户点击 "Login with Farcaster"。
2.  Privy 验证身份并返回 `fid` 和 `embedded_wallet`。
3.  前端调用 `AlchemyAccountProvider`，基于 Privy Signer 计算出 AA 智能钱包地址。
4.  调用 `POST /api/auth/login` 将 `fid` 和 `aa_address` 存入 Postgres。

#### 3.2 询价与交易 (Quote & Bridge)
1.  **询价**: 前端调用 Across SDK/API 获取报价 (`suggestedFees`)。
    *   Params: `originChain: Base`, `destinationChain: Tempo`, `token: USDC`.
2.  **展示**: UI 显示包含 Across 费用和 Gas 费（Sponsored）的最终报价。
3.  **签名**: 用户点击确认，Privy 弹出签名框 (Sign Message/UserOp)。
4.  **上链**: Alchemy Bundler 接收 UserOp，验证 Paymaster 签名，打包上链。
5.  **记录**: 交易成功后，前端将 `acrossDepositId` (或 TxHash) 发送至 `POST /api/trade/record`。

#### 3.3 状态追踪与出金
1.  **轮询**: 前端使用 Across API 轮询跨链状态 (`fillStatus`)。
2.  **到账**: 当状态变为 `FILLED`，Tempo 钱包收到 USDC。
3.  **出金**: 用户发起 Stripe Payout，后端生成 Stripe Session，前端引导用户转账 USDC 到 Stripe 指定地址。

### 4. 数据库 Schema (Prisma)
```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            Int      @id @default(autoincrement())
  fid           String?  @unique // Farcaster ID, MetaMask 用户可能为空
  eoaAddress    String?  @unique @map("eoa_address") // 外部钱包地址 (Privy Embedded or MetaMask)
  walletAddress String?  @map("wallet_address") // AA 钱包地址
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  transactions  Transaction[]
  
  @@map("users")
}

model Transaction {
  id        Int      @id @default(autoincrement())
  bizId     String   @unique // UUID
  userId    Int
  
  // 业务数据
  inputAmount   Decimal  @db.Decimal(36, 18)
  feeAmount     Decimal  @db.Decimal(36, 18)
  outputAmount  Decimal  @db.Decimal(36, 18) // USDC
  
  // 链上数据
  acrossDepositId String? @unique
  baseTxHash    String?
  tempoTxHash   String?
  
  status        String   // PENDING, COMPLETED, FAILED
  
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())
  
  @@map("transactions")
}
```

### 5. 关键 API 定义

#### `POST /api/trade/submit`
*   **功能**: 记录交易初始状态。
*   **输入**: `{ fid: string, quote: object, depositId: string }`
*   **逻辑**: 验证用户存在 -> 解析 Quote -> 创建 PENDING 状态的 Transaction 记录。

#### `GET /api/user/history`
*   **功能**: 获取用户交易历史。
*   **逻辑**: 查询 DB -> 针对 PENDING 的订单，实时调用 Across API 更新状态 -> 返回前端。

---

## 🟣 Part 3: 非功能性需求 (Non-Functional Requirements)

### 1. 数据一致性 (Data Consistency)
由于涉及区块链异步交易和法币结算，系统必须遵循**最终一致性 (Eventual Consistency)** 原则。

*   **状态机同步 (State Machine Sync)：**
    *   **链上为准原则：** 数据库中的状态 (`PENDING`, `COMPLETED`) 仅作为缓存，最终状态必须以链上查询结果或官方 API (Across/Stripe) 为准。
    *   **补偿机制 (Reconciliation)：**
        *   **GitHub Actions (免费版推荐)：** 配置 `.github/workflows/cron.yml`，每 10 分钟触发一次 `/api/cron/reconcile` 接口，实现 100% 最终一致性。详见《技术方案-定时任务(免费版).md》。
        *   **Webhook (推荐)：** 配置 Across (如果支持) 和 Stripe 的 Webhook，被动接收状态变更通知，实时更新 DB。
*   **幂等性设计 (Idempotency)：**
    *   **交易提交：** `POST /api/trade/submit` 接口必须对同一 `acrossDepositId` 进行去重检查。
    *   **出金请求：** Stripe Payout Session 的创建应基于唯一的业务 ID (`bizId`)。

### 2. 安全与合规 (Security & Compliance)
*   **签名验证与鉴权：** 所有涉及敏感操作的 API 必须校验 Privy Auth Token。定时任务 API 必须校验 `CRON_SECRET`。
*   **Paymaster 风控：**
    *   在 Alchemy Dashboard 配置严格的 **Gas Policy**，限制单次 Gas 上限（建议 <$0.50）和合约白名单（仅限 Across SpokePool）。
    *   后端 API 层面实施二级风控，检测异常高频交易 IP。
   **合规性 (Compliance)：** Stripe Payouts 要求用户完成 KYC。前端需处理 Stripe 引导流程，确保只有合规用户能发起提现。

---

## 🟡 Part 3: 实施规划 (Implementation & Operations)

### 1. 关键环境变量清单 (Environment Variables)
为确保项目顺利运行，需在 Vercel 中配置以下变量：
*   `NEXT_PUBLIC_PRIVY_APP_ID`: Privy 身份验证。
*   `ALCHEMY_API_KEY`: 访问链上数据与 Bundler。
*   `ALCHEMY_POLICY_ID`: Paymaster 代付策略。
*   `STRIPE_SECRET_KEY` & `STRIPE_WEBHOOK_SECRET`: 法币出金与回调。
*   `DATABASE_URL`: PostgreSQL 连接字符串。
*   `CRON_SECRET`: 定时任务鉴权密钥（需与 GitHub Secrets 同步）。

### 2. 开发与上线清单 (Checklist)
- [ ] **Phase 1: 基础设施**
    - [ ] 创建 GitHub 仓库并关联 Vercel。
    - [ ] 申请并配置上述所有 API Keys。
    - [ ] 初始化 Prisma 数据库并执行迁移。
- [ ] **Phase 2: 核心功能**
    - [ ] 实现 Privy 登录与 AA 钱包静默创建。
    - [ ] 集成 Across SDK 并完成 Base (USDC) -> Tempo (USDC) 测试网跑通。
    - [ ] 编写 Webhook 接收逻辑并完成幂等性测试。
- [ ] **Phase 3: 自动化与出金**
    - [ ] 部署 GitHub Actions 定时任务。
    - [ ] 完成 Stripe Payout 流程联调（测试模式）。
- [ ] **Phase 4: 上线准备**
    - [ ] 配置 Alchemy Gas Policy 白名单 (Across SpokePool)。
    - [ ] 切换所有 Key 至生产环境 (Mainnet)。

### 3. 异常场景处理
1.  **Paymaster 余额不足：**
    *   API 监控 Alchemy 余额。
    *   低于阈值时，前端 Quote 接口报错，提示 "Service Temporarily Unavailable"。
2.  **滑点过高：**
    *   Across 自动处理费用。如果费用过高，前端提示用户确认。
3.  **跨链卡顿：**
    *   前端提供 Across Explorer 链接，用户可自行查看跨链桥状态。
